---
title: "Financiamento de grandes grupos econômicos na Campanha de parlamentares em exercício"
output: 
  html_document:
    css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.cap = '',
  fig.align = 'center',
  fig.width = 10,
  fig.height = 8
)
```

```{r}
library(tidyverse)
library(here)
library(hrbrthemes)
library(plotly)
library(ggchicklet)
library(ggridges)
library(ggrepel)
library(gridExtra)

source(here("reports/atividades-economicas-doacoes/utils.R"))
source(here("parlametria/processor/empresas/processa_parlamentares_info_eleicao.R"))

theme_set(theme_minimal())
options(scipen = 999)
```

```{r}
doacoes_sumario <- read_csv(here("parlametria/raw_data/empresas/parlamentares_ligacao_atividade_economica.csv"),
                            col_types = cols(id_parlamentar = "c"))

doacoes_sumario_camara <- doacoes_sumario %>% 
  filter(casa == "camara")

doacoes_sumario_senado <- doacoes_sumario %>% 
  filter(casa == "senado")
```

```{r}
doacoes_origem <- processa_parlamentares_info_eleicao()
```

Em 2018, quando foram eleitos 513 Deputados Federais e 54 Senadores, a eleição não permitiu a doação direta de empresas (pessoas jurídicas) para os candidatos, apenas doações de pessoas físicas. Iremos explorar nessa análise a participação dessas pessoas físicas como sócias de empresas e quais os grupos de atividades econômicas que essas empresas pertencem.

Quando for falado em doações de grupos econômicos para Parlamentares, deve ser intepretado como doações de sócios de empresas que atuam neste grupo econômico. Grupo econômico é o ramo de atividade que a empresa pode atuar. A classificação é obtida através da declaração dos CNAE's das empresas na Receita Federal. Foi considerado o CNAE fiscal registrado na Receita Federal para determinatr o grupo econômico de uma empresa.

Se um doador possuir duas ou mais empresas com diferentes grupos econômicos então a doação será dividida pelo número de grupos econômicos. 

```{r}
plot_visao_geral <- function(casa_parlamentar, titulo, titulo_x) {
  set.seed(123)
  
  total_doacoes_socios_empresas <- doacoes_origem %>%
    filter(casa == casa_parlamentar) %>%
    pull(total_receita_doadores_empresas) %>%
    sum()
  
  total_doacoes_pessoa_fisica <- doacoes_origem %>%
    filter(casa == casa_parlamentar) %>%
    pull(pessoa_fisica) %>%
    sum()
  
  total_doacoes_partidos_candidatos <- doacoes_origem %>%
    filter(casa == casa_parlamentar) %>%
    mutate(partidos_candidatos = origem_partido + outros_candidatos) %>%
    pull(partidos_candidatos) %>%
    sum()
  
  visao_geral <- data.frame(
    origem = c("Sócios", "Outros", "Partidos+Candidatos"),
    valor = c(total_doacoes_socios_empresas,
              total_doacoes_pessoa_fisica - total_doacoes_socios_empresas,
              total_doacoes_partidos_candidatos),
    stringsAsFactors = FALSE
  )
  
  paleta <- c("#91bfda", "#E89D68", "#e06264", "#BA7E53")
  
  visao_geral %>%
    mutate(proporcao = valor / sum(valor)) %>%
    ggplot(aes(x = reorder(origem, proporcao), y = proporcao, fill = origem)) +
    geom_chicklet(width = .7, position = "dodge") +
    geom_text(aes(label = stringr::str_remove(string = format_currency(valor), pattern = " milhões")),
              hjust = -0.05,
              position = "dodge"
              ) +
    coord_flip() +
    scale_fill_manual(values = c("Sócios" = paleta[3],
                               "Outros" = paleta[2],
                               "Partidos+Candidatos" = paleta[1]),
                      name = "") +
    scale_y_continuous(breaks = seq(0, 1, 0.25), limits = c(0, 1), labels = scales::percent_format(accuracy = 1)) +
    guides(fill = F) +
    labs(x = "",
         y = titulo_x,
         title = titulo,
         subtitle = "Em milhões de reais") +
    theme_ipsum_rc() 
}
```

```{r fig.height=4}
plot_visao_geral("camara", "Origem do financiamento de campanha \ndos deputados",
                 "Porcentagem do valor total de financiamento para campanha de deputados")
```

```{r fig.height=4}
plot_visao_geral("senado", "Origem do financiamento de campanha \ndos senadores",
                 "Porcentagem do valor total de financiamento para campanha de senadores")
```

A seguir iremos visualizar quais os grupos econômicos que mais doaram para deputados em 2018.

```{r}
doacoes_sumario_por_atividade <- doacoes_sumario_camara %>%
  group_by(grupo_atividade_economica) %>% 
  summarise(total = sum(total_por_atividade))

levels <- doacoes_sumario_por_atividade %>%
  arrange(desc(total)) %>% 
  pull(grupo_atividade_economica)

doacoes_sumario_por_atividade %>% 
  arrange(desc(total)) %>% 
  head(15) %>% 
  ggplot(aes(x = fct_rev(factor(grupo_atividade_economica, levels = levels)), y = total / 1e6, fill = "a")) +
  geom_chicklet(width = .7, radius = grid::unit(5, "pt")) +
  geom_text(aes(label = paste0(round(total / 1e6, 2))),
            hjust = -0.1,
            size = 3.3,
            color = "#333333") +
  coord_flip() +
  scale_fill_manual(values = c("#43a467")) +
  scale_y_continuous(limits = c(0, 15)) +
  guides(fill = FALSE) + 
  labs(title = "Setores econômicos que mais \nfinanciaram campanha para deputados",
       y = "Valor financiado para deputados (milhões de reais)",
       x = "") +
  theme_ipsum_rc() +
  theme(axis.text.y = element_text(size = 10))
```

A seguir a lista dos grupos que mais doaram para senadores

```{r}
doacoes_sumario_por_atividade <- doacoes_sumario_senado %>%
  group_by(grupo_atividade_economica) %>% 
  summarise(total = sum(total_por_atividade))

levels <- doacoes_sumario_por_atividade %>%
  arrange(desc(total)) %>% 
  pull(grupo_atividade_economica)

doacoes_sumario_por_atividade %>% 
  arrange(desc(total)) %>% 
  head(15) %>% 
  ggplot(aes(x = fct_rev(factor(grupo_atividade_economica, levels = levels)), y = total / 1e6, fill = "a")) +
  geom_chicklet(width = .7, radius = grid::unit(5, "pt")) +
  geom_text(aes(label = paste0(round(total / 1e6, 2))),
            hjust = -0.1,
            size = 3.3,
            color = "#333333") +
  coord_flip() +
  scale_fill_manual(values = c("#806CCC")) +
  scale_y_continuous(limits = c(0, 3)) +
  guides(fill = FALSE) + 
  labs(title = "Setores econômicos que mais \nfinanciaram campanha para senadores",
       y = "Valor financiado para senadores (milhões de reais)",
       x = "") +
  theme_ipsum_rc() +
  theme(axis.text.y = element_text(size = 10))
```

## Distribuição dos parlamentares por Grupo Econômico

```{r}
parlamentares_investimento <- read_csv(here("parlametria/raw_data/resumo/parlamentares_investimento.csv"),
                                       col_types = cols(id = "c")) %>%
  select(id_parlamentar = id, casa, partido_eleicao)

doacoes_sumario_alt_camara <- doacoes_sumario_camara %>%
  left_join(parlamentares_investimento, by = c("id_parlamentar", "casa")) %>%
  rowwise() %>%
  mutate(grupo_atividade_economica_raw = grupo_atividade_economica,
         grupo_atividade_economica = str_to_sentence(grupo_atividade_economica),
         grupo_atividade_economica = paste(stringi::stri_wrap(grupo_atividade_economica, 40), collapse = "\n")) %>%
  ungroup()

doacoes_sumario_alt_senado <- doacoes_sumario_senado %>%
  left_join(parlamentares_investimento, by = c("id_parlamentar", "casa")) %>%
  rowwise() %>%
  mutate(grupo_atividade_economica_raw = grupo_atividade_economica,
         grupo_atividade_economica = str_to_sentence(grupo_atividade_economica),
         grupo_atividade_economica = paste(stringi::stri_wrap(grupo_atividade_economica, 40), collapse = "\n")) %>%
  ungroup()

```

A seguir iremos visualizar a distribuição da proporção do recebido pelos parlamentares por Grupo Econômico.

Cada aglomerado de pontos na visualização representa um conjunto de parlamentares posicionados de forma correspondente a proporção de doação recebida de um determinado grupo econômico. A curva de densidade também ajuda a identificar concentração de parlamentares em faixas de valores específicas. A marca "|" rosa na visualização representa a média da proporção dos parlamentares de cada grupo. A visualização mostra os 10 grupos econômicos com maiores médias de proporção da campanha de parlamentares.

```{r}
plot_geom_count_density <- function(data, title, numero_minimo_parlamentares_por_grupo_economico, casa) {
  levels <- data %>%
    filter(!is.na(proporcao_doacao)) %>%
    group_by(grupo_atividade_economica) %>%
    summarise(mean = mean(proporcao_doacao),
              n_parlamentares = n()) %>%
    ungroup() %>%
    filter(n_parlamentares >= numero_minimo_parlamentares_por_grupo_economico) %>% 
    arrange(desc(mean)) %>%
    pull(grupo_atividade_economica)
  top_grupos <- levels %>%
    head(10)
  
  x_barra = 33.5
  x_texto = 41.5
  cores_grafico = c("#af8dc3", "#42a38f")
  
  if (casa == "senado") {
    x_barra = 18.5
    x_texto = 21
    cores_grafico = c("#af8dc3", "#91BFDA")
  }
  data %>%
    filter(!is.na(proporcao_doacao)) %>%
    mutate(proporcao_doacao = proporcao_doacao * 100) %>%
    group_by(grupo_atividade_economica) %>%
    mutate(mean = mean(proporcao_doacao)) %>%
    ungroup() %>%
    filter(grupo_atividade_economica %in% top_grupos) %>%
    ggplot(aes(x = proporcao_doacao,
               y = forcats::fct_rev(factor(grupo_atividade_economica, levels = levels)),
               color = forcats::fct_rev(factor(grupo_atividade_economica, levels = levels)),
               fill = forcats::fct_rev(factor(grupo_atividade_economica, levels = levels)))) +
    # geom_density_ridges(
    #   aes(height = ..density..),
    #   stat = "binline", 
    #   binwidth = 10,
    #   boundary = 0,
    #   scale = 0.9,
    #   alpha = 0.2
    # ) +
    # geom_count(alpha = 0.5, size = 2) +
    geom_point(shape = 124, size = 4) +
    scale_shape_identity() +
    scale_color_manual(values = rep(cores_grafico, 15)) +
    scale_fill_manual(values = rep(cores_grafico, 15)) +
    geom_point(aes(x = mean), size = 1.5, color = "#dc267f", shape = 16) +
    
    geom_point(aes(x = x_barra, y = 10.3), size = 1.5, color = "#dc267f", shape = 16) +
    annotate("text", label = "é a média", x = x_texto, y = 10.3, color = "#4b4545") +
    
    guides(size = F, color = F, fill = F) +
    labs(title = title,
         x = "Participação em campanha (%)",
         y = "Setor econômico") +
    theme_ipsum_rc() +
    theme(axis.text.y = element_text(size = 12),
          axis.title.x = element_text(size = 11),
          axis.title.y = element_text(size = 11))
}
```

```{r}
plot_geom_count_density(doacoes_sumario_alt_camara, "Distribuição da participação \nem campanha para deputados por Setor", 10, "camara")
```

```{r}
plot_geom_count_density(doacoes_sumario_alt_senado, "Distribuição da participação \nem campanha para senadores por Setor", 5, "senado")
```

É possível perceber a ocorrência de vários casos de deputados com proporção de doação vinda do grupo econômico superior a 50% na Câmara. Em alguns casos o valor se aproxima bastante de 100%, ou seja, toda a doação recebida pelo deputado veio de sócios ligados a empresas do Grupo econômico.

Para o Senado, o cenário é um pouco diferente: a maioria dos senadores não concentra nem 20% das doações recebidas em campanha em um grupo específico.

## Distribuição dos parlamentares por Partido

### Para Deputados

A seguir iremos visualizar a distribuição dos deputados dos partidos com mais de 8 filiados. Para cada partido foi calculada a média de quanto cada setor econômico participou na campanha de seus deputados. Foram selecionados os seguintes setores econômicos:
  
 - ATIVIDADES IMOBILIÁRIAS
 - CONSTRUÇÃO
 - ATIVIDADES FINANCEIRAS, DE SEGUROS E SERVIÇOS RELACIONADOS
 - AGRICULTURA, PECUÁRIA, PRODUÇÃO FLORESTAL, PESCA E AQÜICULTURA
 - COMÉRCIO VAREJISTA 
 - EDUCAÇÃO

A barra amarela representa a média geral de quanto o setor econômico participou do financiamento da campanha dos deputados. A barra azul representa a média de quanto o setor econômico participou nas campanhas dos filiados ao partido. A barra cinza indica a interseção dos valores da média geral e da média no partido.

Quando a barra amarela se sobressai significa que a média geral de participação em campanha para aquele setor econômico é maior que a média do partido. Neste caso, a barra cinza irá indicar qual é a média do partido.

Caso a barra azul se sobressaia significa que a média do partido para o setor é maior que a geral. Neste caso a barra amarela irá indicar qual a média geral daquele setor.

Cada gráfico do partido tem sua própria escala. A porcentagem no eixo x indica a média de participação na campanha.

```{r fig.height=30}
plot_financiamento_por_partido <- function(data, lista_partidos, titulo) {
  ggplot(data = data %>% 
         filter(sg_partido %in% lista_partidos, cat != "media_partido"),
       aes(
         x = reorder(grupo_atividade_economica, value),
         y = value,
         fill = cat
       )) +
  geom_col(fill = "#FFD046",
           alpha = .5,
           width = 0.5) +
  geom_col(
    data = filter(data, sg_partido %in% lista_partidos, cat == "media_partido"),
    fill = "#6699CC",
    alpha = .5,
    width = 0.5
  ) +
  lemon::facet_rep_wrap(~ sg_partido,
             ncol = 3,
             scales = "free_y",
             repeat.tick.labels = c("bottom", "right")) +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(title = titulo,
       x = "",
       y = "Participação em campanha (%)") +
  theme_ipsum_rc()
}
```

```{r}
categorias_economicas <- c("ATIVIDADES IMOBILIÁRIAS", "CONSTRUÇÃO", "ATIVIDADES FINANCEIRAS, DE SEGUROS E SERVIÇOS RELACIONADOS", "AGRICULTURA, PECUÁRIA, PRODUÇÃO FLORESTAL, PESCA E AQÜICULTURA", "COMÉRCIO VAREJISTA", "EDUCAÇÃO")

doacoes_sumario_alt_deputados <- doacoes_sumario_alt_camara %>%
  filter(grupo_atividade_economica_raw %in% categorias_economicas) %>%
  group_by(grupo_atividade_economica) %>%
  mutate(media_geral = mean(proporcao_doacao)) %>%
  ungroup() %>%
  group_by(sg_partido, grupo_atividade_economica) %>%
  mutate(media_partido = mean(proporcao_doacao)) %>%
  ungroup() %>%
  distinct(grupo_atividade_economica, sg_partido, media_geral, media_partido) %>%
  gather(key = "cat", value = "value", media_geral:media_partido)

lista_partidos_camara <- doacoes_sumario_alt_camara %>% 
  group_by(sg_partido) %>% 
  summarise(n_parlamentares = n_distinct(id_parlamentar, casa)) %>% 
  filter(n_parlamentares >= 8) %>% 
  pull(sg_partido)
```

```{r fig.height=25}
plot_financiamento_por_partido(doacoes_sumario_alt_deputados, lista_partidos_camara, 
                               "Participação na campanha de deputados \npor partido e grupo econômico")
```

### Para Senadores

Para o Senado, foram selecionados os seguintes setores econômicos:
  
- SAÚDE HUMANA E SERVIÇOS SOCIAIS
- INDÚSTRIA DE MÓVEIS E MADEIRAS
- INDÚSTRIA ALIMENTÍCIA E DE BEBIDAS
- EDUCAÇÃO
- ATIVIDADES FINANCEIRAS, DE SEGUROS E SERVIÇOS RELACIONADOS
- CONSTRUÇÃO

```{r}
categorias_economicas <- c("SAÚDE HUMANA E SERVIÇOS SOCIAIS", "INDÚSTRIA DE MÓVEIS E MADEIRAS", "INDÚSTRIA ALIMENTÍCIA E DE BEBIDAS", "EDUCAÇÃO", "ATIVIDADES FINANCEIRAS, DE SEGUROS E SERVIÇOS RELACIONADOS", "CONSTRUÇÃO")

doacoes_sumario_alt_senadores <- doacoes_sumario_alt_senado %>%
  filter(grupo_atividade_economica_raw %in% categorias_economicas) %>%
  group_by(grupo_atividade_economica) %>%
  mutate(media_geral = mean(proporcao_doacao)) %>%
  ungroup() %>%
  group_by(sg_partido, grupo_atividade_economica) %>%
  mutate(media_partido = mean(proporcao_doacao)) %>%
  ungroup() %>%
  distinct(grupo_atividade_economica, sg_partido, media_geral, media_partido) %>%
  gather(key = "cat", value = "value", media_geral:media_partido)

lista_partidos_senado <- doacoes_sumario_alt_senado %>% 
  group_by(sg_partido) %>% 
  summarise(n_parlamentares = n_distinct(id_parlamentar, casa)) %>% 
  pull(sg_partido)
```

```{r fig.height=15}
plot_financiamento_por_partido(doacoes_sumario_alt_senadores, lista_partidos_senado, 
                               "Participação na campanha de senadores \npor partido e grupo econômico")
```

<!-- ## Distribuição dos parlamentares por Comissão Permanente -->

<!-- ```{r} -->
<!-- comissoes <- read_csv(here("crawler/raw_data/comissoes.csv")) -->
<!-- ``` -->




