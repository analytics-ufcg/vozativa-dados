---
title: "Encontrando grupos de deputados por coautorias em proposições"
runtime: shiny
output:
  html_document:
    code_folding: hide
    css: style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.cap = '',
  fig.align = 'center',
  fig.width = 10,
  fig.height = 8
)
```

```{r echo = FALSE, warning=FALSE, message=FALSE}
library(networkD3)
library(tidyverse)
library(hrbrthemes)
theme_set(theme_minimal())

env <- "dev"
path <- ''

if (env == "dev") {
  path = "reports/coautorias/"
} 

source(here::here(paste0(path, "scripts/analyzer_autorias.R")))
source(here::here(paste0(path, "scripts/fetcher_autorias.R")))
source(here::here(paste0(path, "scripts/generate-graph.R")))

URL_AUTORES <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRbKSW1aX8iyQ6Y7zl8zwluFUJ2nCoFunDvtZQ5gicXrpCpjRulWGsSjwUzhwrpIGfOr1Pb8KmaZVU9/pub?gid=563462053&single=true&output=csv"

URL_PROPOSICOES <-
  "https://dadosabertos.camara.leg.br/arquivos/proposicoes/csv/proposicoes-2019.csv"

URL_COAUTORIAS <- ""
URL_RELACIONADAS <- ""
URL_PARLAMENTARES <- ""

```

```{r echo = FALSE, warning=FALSE, message=FALSE}

proposicoes <- get_dataset_proposicoes(URL_PROPOSICOES)

parlamentares <- get_dataset_parlamentares(URL_PARLAMENTARES)

autores <- get_dataset_autores(URL_AUTORES)

coautorias <- get_dataset_coautorias(URL_COAUTORIAS)

relacionadas <- get_dataset_relacionadas(URL_RELACIONADAS)

min_range <- min(coautorias$peso_arestas)
max_range <- max(coautorias$peso_arestas)

rm(coautorias)

```

## Escolhendo uma proposição para análise

É possível exibir um grafo contendo os grupos dos parlamentares e uma tabela detalhando as proposições relacionadas (requerimentos, apensadas, emendas, etc.) de uma proposição selecionada e a partir do peso mínimo, um valor inversamente proporcional ao número de co-autores por proposição: se uma proposição possui dois co-autores, o peso das arestas será 1/2 = 0.5; já uma proposição com 100 co-autorias terá peso igual a 0.1.

```{r echo=FALSE, warning=FALSE}
choices <- c(proposicoes$choice)

selectInput("proposition", label = "Selecione a proposição:",
              choices = choices, selected = choices[30])
br()

selectInput("min_peso", "Valor mínimo dos pesos:",
              choices = seq(
               min_range %>% 
                  round(2), 
                max_range %>% 
                  round(2),
                0.5), 
            selected = choices[1])
br()

plotOutput("hist")
```

#### Tabela de pares de co-autorias

```{r echo=FALSE}
DT::DTOutput("dt")
```

#### Grafo de grupos

```{r echo=FALSE}
  forceNetworkOutput("grafo")
```


```{r echo=FALSE, context="server"}

output$hist <- renderPlot({
  coautores <- getCoautorias()[[1]]
  if(nrow(coautores) > 0) {
    coautores %>%
    filter(peso_arestas >= input$min_peso) %>% 
    ggplot(aes(x = peso_arestas)) +
    geom_histogram(boundary = 0, fill = "#1BB5A9", color = "#10726B", binwidth = 1) +
    scale_x_continuous(breaks = seq(0, max(coautores$peso_arestas) + 0.1, 1)) +
    labs(x = "Peso das relações", y = "Número de relações") +
    theme_ipsum_rc()
  }
})

getCoautorias <- reactive({
  proposicao <- 
    proposicoes %>% 
    filter(choice == input$proposition)
  
  rels <- relacionadas %>% 
    filter(id_principal == proposicao$id)
  
  coautores <- filter_coautorias(rels, input$min_peso)
  
  if(nrow(coautores) > 0) {
     nodes_and_edges <- 
       generate_nodes_and_edges(
        autores,
        parlamentares,
        coautores)
  } else {
    nodes_and_edges <- list(tribble(), tribble())
  }
 
  return(list(coautores, nodes_and_edges))
})

output$dt <- 
  DT::renderDataTable(
    getCoautorias()[[1]] %>% 
      # select(nome_eleitoral.x, nome_eleitoral.y, peso_arestas, num_coautorias) %>% 
      distinct() %>% 
      filter(peso_arestas >=  input$min_peso) %>% 
      rename(peso_relacao = peso_arestas#, 
             # nome_deputado_a = nome_eleitoral.x,
             # nome_deputado_b = nome_eleitoral.y,
            # coautorias_conjuntas = num_coautorias
             ) %>% 
      arrange(desc(peso_relacao)), 
    options = list(pageLength = 10,
                   scrollX = TRUE))
  
output$grafo_grupo1 <- 
  networkD3::renderForceNetwork({
    autorias <- getCoautorias()[[2]]
    nodes <- autorias[[1]]
    edges <- autorias[[2]]
    if (nrow(nodes) > 0 && nrow(edges) > 0){
      generate_graph(nodes, edges)
    }
  })

```
