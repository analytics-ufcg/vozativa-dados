---
title: "Aderência dos Senadores em votações de plenário"
output: 
  html_document:
    css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.cap = '',
  fig.align = 'center',
  fig.width = 10,
  fig.height = 8
)
```

```{r results='hide'}
library(tidyverse)
library(DT)
library(ggplot2)
library(scales)
library(hrbrthemes)
library(ggchicklet)
library(here)
source(here("crawler/proposicoes/fetcher_proposicoes_senado.R"))
```

```{r results='hide'}
theme_set(theme_minimal())

votos <- read_csv(here("reports/aderencia-senado/data/votos.csv")) %>% 
  filter(casa == "senado")

numero_votacoes <- votos %>% 
  count(id_votacao) %>% 
  nrow()

senadores <- read_csv(here("crawler/raw_data/senadores.csv")) %>% 
  filter(em_exercicio == 1) %>% 
  mutate(nome_exibido = paste0(nome_eleitoral, " - ", sg_partido, "/", uf),
         id = as.character(id)) %>% 
  select(id, nome_exibido)

aderencia <- read_csv(here("reports/aderencia-senado/data/aderencia.csv")) %>% 
  mutate(id = str_remove(id_parlamentar_voz, "^(\\d){1}"), #remove o 1 do id_parlamentar_voz
         freq = (numero_votacoes - faltou)/numero_votacoes) %>% 
  filter(id_partido == 0, id_tema == 99)

aderencia <- aderencia %>% 
  left_join(senadores, by="id") %>% 
  filter(!is.na(nome_exibido))

proposicoes <- fetch_proposicoes_plenario_selecionadas_senado()
```

### Resumo

Analisamos os senadores que mais seguem e o menos "obedientes" ao governo nas votações nominais de plenário do Senado Federal ocorridas em em 2019.

<br>

### O que é aderência

Aderência é uma faceta da atuação dos Deputados e Senadores Federais nas votações em plenário de cada casa. Um parlamentar é aderente ao Governo quando segue as orientações do Governo em votações nominais. Neste relatório, focamos nos senadores.

Para cada votação de cada senador, identificamos se ele seguiu a orientação do Governo ou não. Em seguida, calculamos o grau de aderência como a proporção das votações em que ele seguiu a orientação do Governo. Quando o Governo não apresentou orientação em uma votação, consideramos o voto do Líder do Governo como orientação.

Ao total temos `r votos %>% count(id_votacao) %>% nrow()` votações em plenário.

## Aderência ao Governo
### Quem tem menos aderência?

Abaixo temos os 20 senadores que possuem menos aderência ao governo. Eles estão ordenados pelo número de vezes que não seguiram a orientação do governo e pela frequência dos senadores nas votações.

```{r}

theme_set(theme_classic())

# Plot
aderencia %>% 
  filter(id_tema == 99) %>% 
  arrange(desc(nao_seguiu), desc(freq)) %>% 
  head(20) %>% 
  ggplot(aes(x = reorder(nome_exibido, nao_seguiu), y = nao_seguiu)) + 
  geom_point(col="tomato3", size = 3) + 
  geom_segment(aes(x = nome_exibido, 
                   xend = nome_exibido, 
                   y = 0, 
                   yend = nao_seguiu), 
               size = 0.1) +
  coord_flip() +
  labs(title = "Senadores com menos aderência ao Governo",
       y = "Nº de votações em que não seguiu o Governo",
       x = "Senador") +
    theme_ipsum_rc()
```

### Mais detalhes sobre quem não adere

```{r}
paleta <- c("#91bfda", "#E89D68", "#e06264")
match_valores <- c("seguiu", "faltou", "nao_seguiu")

data_long <- aderencia %>% 
  arrange(desc(nao_seguiu), freq, faltou) %>% 
  head(20) %>% 
  gather("match", "n", faltou:seguiu) %>% 
  filter(match %in% match_valores)
  
levels <- aderencia %>% 
  arrange(desc(nao_seguiu), freq, faltou) %>% 
  pull(nome_exibido)

data_long %>% 
  mutate(match = factor(match, 
                        levels = c("faltou",
                                   "nao_seguiu",
                                   "seguiu"),
                        ordered = TRUE)) %>% 
  filter(n > 0) %>% 
  ggplot(aes(x = fct_rev(factor(nome_exibido, levels = levels)), y = n, fill = match)) +
  geom_chicklet(width = .7, stat = "identity", position = "stack") +
  geom_text(aes(label = n),
            hjust = 1.3,
            position = "stack"
            ) +
  coord_flip() +
  scale_fill_manual(values = c(
                               "faltou" = paleta[2], 
                               "nao_seguiu" = paleta[3],
                               "seguiu" = paleta[1]),
                    name = "", labels = c("Faltou",
                                          
                                          "Não seguiu",
                                          "Seguiu")) +
  labs(x = "Senador", 
       y = "Nº de votações", 
       title = "Senadores com menos aderência ao Governo",
       subtitle = "Ordenados por frequência de aderência") + 
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_ipsum_rc() +
  theme(legend.position = "bottom",
        plot.subtitle = element_text(size = 12))
```

### Quem tem mais aderência?
```{r fig.height=7}
levels <- aderencia %>%
  arrange(desc(seguiu), desc(freq), faltou) %>% 
  pull(nome_exibido)

aderencia %>% 
  arrange(desc(seguiu), desc(freq), faltou) %>% 
  head(20) %>% 
  ggplot(aes(x = fct_rev(factor(nome_exibido, levels = levels)), y = seguiu)) + 
  geom_point(col="tomato3", size = 3) + 
  geom_segment(aes(x = nome_exibido, 
                   xend = nome_exibido, 
                   y = 0, 
                   yend = seguiu), 
               size = 0.1) +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, 2)) +
  labs(title = "Senadores com mais aderência ao Governo",
       y = "Nº de votações em que seguiu o Governo",
       x = "Senador") +
    theme_ipsum_rc()
```

```{r}
paleta <- c("#91bfda", "#E89D68", "#e06264")
match_valores <- c("seguiu", "faltou", "nao_seguiu")

data_long <- aderencia %>% 
  arrange(desc(nao_seguiu), freq, faltou) %>% 
  head(20) %>% 
  gather("match", "n", faltou:seguiu) %>% 
  filter(match %in% match_valores)
  
levels <- aderencia %>% 
  arrange(desc(nao_seguiu), freq, faltou) %>% 
  pull(nome_exibido)

data_long %>% 
  mutate(match = factor(match, 
                        levels = c("faltou",
                                   "nao_seguiu",
                                   "seguiu"),
                        ordered = TRUE)) %>% 
  filter(n > 0) %>% 
  ggplot(aes(x = fct_rev(factor(nome_exibido, levels = levels)), y = n, fill = match)) +
  geom_chicklet(width = .7, stat = "identity", position = "stack") +
  geom_text(aes(label = n),
            hjust = 1.3,
            position = "stack"
            ) +
  coord_flip() +
  scale_fill_manual(values = c(
                               "faltou" = paleta[2], 
                               "nao_seguiu" = paleta[3],
                               "seguiu" = paleta[1]),
                    name = "", labels = c("Faltou",
                                          
                                          "Não seguiu",
                                          "Seguiu")) +
  labs(x = "Senador", 
       y = "Nº de votações", 
       title = "Senadores com menos aderência ao Governo",
       subtitle = "Ordenados por frequência de aderência") + 
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_ipsum_rc() +
  theme(legend.position = "bottom",
        plot.subtitle = element_text(size = 12))
```

### Aderência nos partidos
### Aderência nas Comissões
### Quantos deputados são aderentes ao Governo em Meio Ambiente e Agenda Nacional