---
title: "Aderência dos Senadores em votações de plenário"
output: 
  html_document:
    css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.cap = '',
  fig.align = 'center',
  fig.width = 10,
  fig.height = 8
)
```

```{r results='hide'}
library(tidyverse)
library(DT)
library(ggplot2)
library(scales)
library(hrbrthemes)
library(here)
library(ggchicklet)
source(here("crawler/proposicoes/fetcher_proposicoes_senado.R"))
source(here("crawler/votacoes/aderencia/analyzer_aderencia.R"))
```

```{r results='hide'}
theme_set(theme_minimal())

votos <- read_csv(here("reports/aderencia-senado/data/votos.csv")) %>% 
  filter(casa == "senado")

numero_votacoes <- votos %>% 
  count(id_votacao) %>% 
  nrow()

senadores <- read_csv(here("crawler/raw_data/senadores.csv")) %>% 
  filter(em_exercicio == 1) %>% 
  mutate(nome_exibido = paste0(nome_eleitoral, " - ", sg_partido, "/", uf),
         id = as.character(id)) %>% 
  select(id, nome_exibido)

partidos <- read_csv(here("crawler/raw_data/partidos.csv")) %>% 
  select(id, sigla)

aderencia <- 
  processa_aderencia_parlamentares(
    proposicoes_url = NULL,
    casa_aderencia = "senado") %>%  
  filter(str_detect(id_parlamentar_voz, "^2.*")) %>% 
  mutate(id = str_remove(id_parlamentar_voz, "^(\\d){1}")) %>%  #remove o dígito 2 do id_parlamentar_voz
  left_join(senadores, by="id") %>% 
  filter(!is.na(nome_exibido), aderencia >= 0) %>% 
  left_join(partidos, by=c("id_partido"="id")) %>% 
  select(-id_partido) %>% 
  rename(partido = sigla) %>% 
  mutate(freq = (seguiu / (seguiu + nao_seguiu)) * 100) %>%
  mutate(freq = if_else(is.nan(freq), -1, freq))
  

aderencia_governo <- aderencia  %>% 
  filter(partido == "Governo", id_tema == 99)

aderencia_partido <- aderencia %>% 
  filter(partido != "Governo")

proposicoes <- fetch_proposicoes_plenario_selecionadas_senado()
```

### Resumo

Analisamos os senadores que mais seguem e o menos "obedientes" ao governo nas votações nominais de plenário do Senado Federal ocorridas em 2019.

<br>

### O que é aderência

Aderência é uma faceta da atuação dos Deputados e Senadores Federais nas votações em plenário de cada casa. Um parlamentar é aderente ao Governo quando segue as orientações do Governo em votações nominais. Neste relatório, focamos nos senadores.

Para cada votação de cada senador, identificamos se ele seguiu a orientação do Governo ou não. Em seguida, calculamos o grau de aderência como a proporção das votações em que ele seguiu a orientação do Governo. Quando o Governo não apresentou orientação em uma votação, consideramos o voto do Líder do Governo como orientação.

Ao total temos `r votos %>% count(id_votacao) %>% nrow()` votações em plenário.

## Aderência ao Governo
### Quem tem menos aderência?

Abaixo temos os 20 senadores que possuem menos aderência ao governo. Eles estão ordenados pela frequência dos votos em que não seguiram a orientação do Governo. Esta frequência é definida como **nº de votos que seguiu / nº de votos totais** que o senador teve, ignorando os casos onde o partido liberou ou o senador faltou.

```{r fig.height=7}

levels <- aderencia_governo %>%
  arrange(freq, desc(nao_seguiu)) %>% 
  pull(nome_exibido)

aderencia_governo %>% 
  arrange(freq, desc(nao_seguiu)) %>% 
  head(20) %>% 
  ggplot(aes(x = fct_rev(factor(nome_exibido, levels = levels)), y = nao_seguiu)) + 
  geom_point(col="tomato3", size = 3) + 
  geom_segment(aes(x = nome_exibido, 
                   xend = nome_exibido, 
                   y = 0, 
                   yend = nao_seguiu), 
               size = 0.1) +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, max(aderencia_governo$nao_seguiu), 1)) +
  labs(title = "Senadores com menos aderência ao Governo",
       y = "Nº de votações em que seguiu o Governo",
       x = "Senador",
       subtitle = "Os que mais frequentemente não seguem o governo") +
    theme_ipsum_rc()
```

É possível observar os senadores que frequentemente seguem menos a orientação do governo: o partido que possui deputados menos aderentes é o PODEMOS, 

### Mais detalhes sobre quem não adere

```{r}
paleta <- c("#91bfda", "#CCCCCC", "#e06264")
match_valores <- c("seguiu", "faltou", "nao_seguiu")

data_long <- aderencia_governo %>% 
  arrange(freq, desc(nao_seguiu), faltou) %>% 
  head(20) %>% 
  gather("match", "n", faltou:seguiu) %>% 
  filter(match %in% match_valores)
  
levels <- aderencia_governo %>% 
  arrange(freq, desc(nao_seguiu), faltou) %>% 
  pull(nome_exibido)

data_long %>% 
  mutate(match = factor(match, 
                        levels = c("faltou",
                                   "nao_seguiu",
                                   "seguiu"),
                        ordered = TRUE)) %>% 
  filter(n > 0) %>% 
  ggplot(aes(x = fct_rev(factor(nome_exibido, levels = levels)), y = n, fill = match)) +
  geom_chicklet(width = .7, stat = "identity", position = "stack") +
  geom_text(aes(label = n),
            hjust = 1.3,
            position = "stack"
            ) +
  coord_flip() +
  scale_fill_manual(values = c(
                               "faltou" = paleta[2], 
                               "nao_seguiu" = paleta[3],
                               "seguiu" = paleta[1]),
                    name = "", labels = c("Faltou",
                                          "Não seguiu",
                                          "Seguiu")) +
  labs(x = "Senador", 
       y = "Nº de votações", 
       title = "Senadores com menos aderência ao Governo",
       subtitle = "Ordenados por frequência de aderência") + 
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_ipsum_rc() +
  theme(legend.position = "bottom",
        plot.subtitle = element_text(size = 12))
```

### Quem tem mais aderência?
```{r fig.height=7}
levels <- aderencia_governo %>%
  arrange(desc(freq), desc(seguiu), faltou) %>% 
  pull(nome_exibido)

aderencia_governo %>% 
  arrange(desc(freq), desc(seguiu), faltou) %>% 
  head(20) %>% 
  ggplot(aes(x = fct_rev(factor(nome_exibido, levels = levels)), y = seguiu)) + 
  geom_point(col="tomato3", size = 3) + 
  geom_segment(aes(x = nome_exibido, 
                   xend = nome_exibido, 
                   y = 0, 
                   yend = seguiu), 
               size = 0.1) +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, 2)) +
  labs(title = "Senadores com mais aderência ao Governo",
       y = "Nº de votações em que seguiu o Governo",
       x = "Senador") +
    theme_ipsum_rc()
```

```{r}
paleta <- c("#91bfda", "#CCCCCC", "#e06264")
match_valores <- c("seguiu", "faltou", "nao_seguiu")

data_long <- aderencia_governo %>% 
  arrange(desc(freq), desc(seguiu), faltou) %>% 
  head(20) %>% 
  gather("match", "n", faltou:seguiu) %>% 
  filter(match %in% match_valores)
  
levels <- aderencia_governo %>% 
  arrange(desc(freq), desc(seguiu), faltou) %>% 
  pull(nome_exibido)

data_long %>% 
  mutate(match = factor(match, 
                        levels = c("faltou",
                                   "nao_seguiu",
                                   "seguiu"),
                        ordered = TRUE)) %>% 
  filter(n > 0) %>% 
  ggplot(aes(x = fct_rev(factor(nome_exibido, levels = levels)), y = n, fill = match)) +
  geom_chicklet(width = .7, stat = "identity", position = "stack") +
  geom_text(aes(label = n),
            hjust = 1.3,
            position = "stack"
            ) +
  coord_flip() +
  scale_fill_manual(values = c(
                               "faltou" = paleta[2], 
                               "nao_seguiu" = paleta[3],
                               "seguiu" = paleta[1]),
                    name = "", labels = c("Faltou",
                                          "Seguiu")) +
  labs(x = "Senador", 
       y = "Nº de votações", 
       title = "Senadores com mais aderência ao Governo",
       subtitle = "Ordenados por frequência de aderência") + 
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_ipsum_rc() +
  theme(legend.position = "bottom",
        plot.subtitle = element_text(size = 12))
```

### Aderência nos partidos
```{r}
partidos <- aderencia %>% 
  filter(partido != "Governo", partido != "SPART") %>% 
  group_by(partido) %>% 
  summarise(n = n(),
         median = median(freq)) %>% 
  ungroup() %>% 
  arrange(median) %>% 
  mutate(partido = factor(partido, levels = unique(partido)))

levels <- partidos %>% 
  pull(partido)
```

```{r}
aderencia_partido %>% 
  filter(partido != "SPART") %>% 
  group_by(partido) %>% 
  mutate(n = n(),
         median = median(freq),
         aderencia = aderencia * 100) %>% 
  ungroup() %>% 
  filter(partido %in% (partidos %>% pull(partido))) %>% 
  ggplot(aes(x = factor(partido, levels = levels), y = freq, color = factor(partido, levels = levels))) +
  geom_count() +
  scale_x_discrete(position = "left") +
  scale_y_continuous(breaks = seq(0, 100, 5), position = "bottom", sec.axis = dup_axis()) +
  scale_color_manual(values = rep(c("#af8dc3", "#FF816E"), 15)) +
  coord_flip() +
  scale_shape_identity() +
  geom_point(aes(y = median), size = 3.5, color = "black", shape = 124) +
  labs(x = "", y = "Aderência ao Governo (%)",
       title = "Distribuição da aderência dos senadores \nnos partidos") +
  guides(color = FALSE, size = FALSE) +
  theme_ipsum_rc()
```

### Aderência nas Comissões

```{r}
comissoes <- readr::read_csv(here::here("crawler/raw_data/comissoes.csv")) %>% 
  filter(casa == "senado")
composicao_comissoes <- readr::read_csv(here::here("crawler/raw_data/composicao_comissoes.csv"), 
                                        col_types = cols(id_parlamentar = "c")) %>% 
  filter(casa == "senado")

composicao_comissoes <- composicao_comissoes %>% 
  left_join(comissoes, by = c("comissao_id" = "id")) %>% 
  select(comissao_id, id_parlamentar, cargo, sigla, nome_comissao = nome)

senadores_comissoes <- aderencia_governo %>% 
  inner_join(composicao_comissoes, by = c("id" = "id_parlamentar"))
```

```{r}
comissoes <- senadores_comissoes %>% 
  group_by(sigla) %>% 
  summarise(n = n(),
         median = median(freq)) %>% 
  ungroup() %>% 
  arrange(median) %>%
  mutate(sigla = factor(sigla, levels = unique(sigla)))

levels <- comissoes %>% 
  pull(sigla)
```

```{r}
senadores_comissoes %>% 
  group_by(sigla) %>% 
  mutate(n = n(),
         median = median(freq)) %>% 
  ungroup() %>%
  ggplot(aes(x = factor(sigla, levels = levels), y = freq, color = factor(sigla, levels = levels))) +
  geom_count() +
  scale_x_discrete(position = "left") +
  scale_y_continuous(breaks = seq(0, 100, 5), position = "bottom", sec.axis = dup_axis()) +
  scale_color_manual(values = rep(c("#af8dc3", "#FF816E"), 15)) +
  coord_flip() +
  scale_shape_identity() +
  geom_point(aes(y = median), size = 3.5, color = "black", shape = 124) +
  labs(x = "", y = "Aderência ao Governo (%)",
       title = "Distribuição da aderência dos senadores \nnas Comissões") +
  guides(color = FALSE, size = FALSE) +
  theme_ipsum_rc()
```